# üìÖ Session du 3 D√©cembre 2024 ‚Äî Character Sheet V2 & Photos de Base

**Date** : 3 d√©cembre 2024  
**Dur√©e** : En cours  
**Objectif** : Am√©liorer le character sheet de Mila et g√©n√©rer les photos de r√©f√©rence

---

## ‚úÖ ACCOMPLI

### 1. Character Sheet VERSION 2 Ultra-D√©taill√©e

**Fichier** : `docs/03-PERSONNAGE.md`

#### Modifications Identit√© & M√©tier
- ‚úÖ Plus √©tudiante ‚Üí **Personal Trainer** (m√©tier principal, 4-5 clients/jour)
- ‚úÖ Ajout **Side hustle : Photographe Lifestyle** (shoots weekends/voyages)
- ‚úÖ Revenus cr√©dibles : ~3-4k‚Ç¨/mois √† 22 ans
- ‚úÖ Justification parfaite pour fitness content + voyages

#### Modifications Physiques D√©taill√©es

**Visage :**
- ‚úÖ Forme ovale allong√©, pommettes hautes
- ‚úÖ Yeux en amande hazel-vert avec reflets dor√©s
- ‚úÖ Nez droit, pointe l√©g√®rement relev√©e
- ‚úÖ L√®vres pulpeuses naturelles, l√©g√®rement asym√©triques
- ‚úÖ Sourcils fournis naturels, l√©g√®rement arqu√©s
- ‚úÖ **Cheveux boucl√©s type 3A** (loose curls), copper auburn, mi-longs √©paules

**Signes Distinctifs CRITIQUES (pour consistance IA) :**
- ‚úÖ **3 grains de beaut√©** avec positions exactes :
  - L√®vre gauche (2mm au-dessus du coin)
  - Pommette droite (centre)
  - √âpaule droite (pr√®s clavicule)
- ‚úÖ **20-25 taches de rousseur** concentr√©es nez/pommettes + √©paules
- ‚úÖ Collier √©toile dor√© (signature permanente)
- ‚úÖ **Suppression du piercing langue** (d√©cision design)

**Corps :**
- ‚úÖ **Silhouette fine athl√©tique** (168cm, 56-58kg)
- ‚úÖ **Poitrine natural E-cup / F-cup** (tr√®s g√©n√©reuse mais naturelle) - It√©rations progressives
- ‚úÖ Taille 66cm avec abdos subtils visibles
- ‚úÖ Proportions exactes d√©taill√©es (√©paules 38cm, jambes toniques, etc.)
- ‚úÖ **Pas de lunettes** confirm√©
- ‚úÖ **Pas de piercings** (aucun)

#### Enrichissement Contenu

**Expressions & Poses :**
- ‚úÖ **18 variations d'expressions** avec prompts d√©taill√©s
  - Confident Smile, Playful Smirk, Serious Gaze, Pensive Look, etc.
  - Chaque expression avec description + mood + contexte usage
  
- ‚úÖ **25 poses organis√©es** par cat√©gorie :
  - 8 Standing poses
  - 7 Sitting poses
  - 5 Action/Movement poses
  - 5 Intimate/Sensual poses

**Captions :**
- ‚úÖ **50+ exemples de captions** r√©partis :
  - 20 Lifestyle
  - 20 Fitness/Training (angle Personal Trainer)
  - 20 Sexy-l√©ger/Confidence
  - 10 Photographe/Creative (nouveau m√©tier)

#### Prompts IA VERSION 2

- ‚úÖ **Prompt de base ultra-d√©taill√©** (~700 mots)
  - Tous les d√©tails faciaux pr√©cis
  - Les 3 grains de beaut√© avec positions exactes
  - Les taches de rousseur
  - Proportions corporelles compl√®tes
  - Optimis√© pour g√©n√©ration IA (Gemini, Nano Banana Pro, etc.)

- ‚úÖ **Negative prompts d√©taill√©s** par type de contenu :
  - Global (toujours inclure)
  - Sp√©cifique Fitness
  - Sp√©cifique Lifestyle
  - Sp√©cifique Beach/Bikini
  - Sp√©cifique Bedroom/Intimate

- ‚úÖ **Checklist de validation** post-g√©n√©ration (12 checks avec priorit√©s)

**R√©sultat** : Document pass√© de ~377 lignes ‚Üí **~700 lignes**

---

### 2. G√©n√©ration des 6 Photos de Base

**Outil utilis√©** : Google AI Studio (Gemini 2.0 Flash)  
**Strat√©gie** : Photo 1 comme r√©f√©rence master pour toutes les suivantes

#### Photos G√©n√©r√©es

| # | Type | Contexte | Status |
|---|------|----------|--------|
| 1 | **Portrait Studio Neutre** | R√©f√©rence visage master, √©clairage parfait | ‚úÖ G√©n√©r√© |
| 2 | **Lifestyle Caf√© Parisien** | Terrasse caf√©, blazer beige, morning vibe | ‚úÖ G√©n√©r√© |
| 3 | **Fitness/Sport** | Gym moderne, tenue Alo Yoga olive, full body | ‚úÖ G√©n√©r√© |
| 4 | **Glamour/Soir√©e** | Robe noire √©l√©gante, mood sensuel sophistiqu√© | ‚úÖ G√©n√©r√© |
| 5 | **Plage/√ât√© Nice** | Bikini terracotta, Mediterranean beach, golden hour | ‚úÖ G√©n√©r√© |
| 6 | **Selfie Authentique** | Mirror selfie, athleisure cozy, bedroom | ‚úÖ G√©n√©r√© |

**Approche utilis√©e :**
- Photo 1 : G√©n√©ration pure avec prompt ultra-d√©taill√©
- Photos 2-6 : Photo 1 en input + prompt contextualis√© (garantit coh√©rence faciale)

**Caract√©ristiques finales :**
- Poitrine : E-cup / F-cup (tr√®s g√©n√©reuse)
- Pas de piercing
- 3 grains de beaut√© + 20-25 taches de rousseur
- Cheveux boucl√©s type 3A copper auburn
- Coh√©rence maintenue sur les 6 photos

---

---

## ‚úÖ PHASE 2 : Upload Cloudinary (TERMIN√â)

### A. 6 Photos Upload√©es sur Cloudinary

| # | Type | URL Cloudinary |
|---|------|----------------|
| 1 | Portrait Studio | `https://res.cloudinary.com/dily60mr0/image/upload/v1764767097/Photo_1_ewwkky.png` |
| 2 | Caf√© Parisien | `https://res.cloudinary.com/dily60mr0/image/upload/v1764767099/Photo_2_q8kxit.png` |
| 3 | Fitness/Gym | `https://res.cloudinary.com/dily60mr0/image/upload/v1764767098/Photo_3_nopedx.png` |
| 4 | Glamour/Soir√©e | `https://res.cloudinary.com/dily60mr0/image/upload/v1764767099/Photo_4_pna4fo.png` |
| 5 | Plage Nice | `https://res.cloudinary.com/dily60mr0/image/upload/v1764767097/Photo_5_kyx12v.png` |
| 6 | Selfie Authentique | `https://res.cloudinary.com/dily60mr0/image/upload/v1764767097/Photo_6_i5rdpa.png` |

### B. Configuration `.env.local`

```bash
MILA_BASE_FACE_URL=https://res.cloudinary.com/dily60mr0/image/upload/v1764767097/Photo_1_ewwkky.png

MILA_REFERENCE_URLS=https://res.cloudinary.com/dily60mr0/image/upload/v1764767099/Photo_2_q8kxit.png,https://res.cloudinary.com/dily60mr0/image/upload/v1764767098/Photo_3_nopedx.png,https://res.cloudinary.com/dily60mr0/image/upload/v1764767099/Photo_4_pna4fo.png,https://res.cloudinary.com/dily60mr0/image/upload/v1764767097/Photo_5_kyx12v.png,https://res.cloudinary.com/dily60mr0/image/upload/v1764767097/Photo_6_i5rdpa.png
```

---

## ‚úÖ PHASE 3 : Impl√©mentation Nano Banana Pro (TERMIN√â)

### D√©cision : Migration vers Nano Banana Pro

**Mod√®le choisi** : `google/nano-banana-pro` via Replicate API

**Raisons :**
- ‚úÖ Supporte jusqu'√† **14 images de r√©f√©rence** pour consistance faciale
- ‚úÖ Google DeepMind's state-of-the-art model (bas√© sur Gemini 3 Pro)
- ‚úÖ R√©solution jusqu'√† 4K
- ‚úÖ 1.8M runs sur Replicate (mod√®le valid√©)

### Probl√®mes Rencontr√©s & Solutions

#### ‚ùå Probl√®me 1 : Nom du Mod√®le Incorrect

**Erreur :** `Model not found`

**Cause :** J'avais utilis√© `nanobanana/nanobanana-pro` au lieu du vrai nom.

**Solution :** Le bon nom est `google/nano-banana-pro` (propri√©taire = Google)

```typescript
// ‚ùå INCORRECT
await replicate.run("nanobanana/nanobanana-pro:latest", {...})

// ‚úÖ CORRECT
await replicate.run("google/nano-banana-pro", {...})
```

---

#### ‚ùå Probl√®me 2 : Param√®tres Non Support√©s

**Erreur :** `Prediction failed: null` (HTTP 422 Unprocessable Entity)

**Cause :** J'envoyais des param√®tres qui n'existent pas pour ce mod√®le.

**Param√®tres INVALIDES (supprim√©s) :**
- ‚ùå `negative_prompt`
- ‚ùå `guidance_scale`
- ‚ùå `num_inference_steps`
- ‚ùå `num_outputs`
- ‚ùå `output_quality`

**Param√®tres VALIDES (seuls accept√©s) :**
- ‚úÖ `prompt` (required)
- ‚úÖ `image_input` (array of URIs, max 14)
- ‚úÖ `aspect_ratio` (ex: "4:5")
- ‚úÖ `resolution` (ex: "2K")
- ‚úÖ `output_format` (ex: "jpg")
- ‚úÖ `safety_filter_level` (ex: "block_only_high")

**Sch√©ma API r√©cup√©r√© via :**
```bash
curl -s "https://api.replicate.com/v1/models/google/nano-banana-pro" \
  -H "Authorization: Bearer $TOKEN" | jq '.latest_version.openapi_schema.components.schemas.Input'
```

---

#### ‚ùå Probl√®me 3 : Format de Sortie Binaire

**Erreur :** Image g√©n√©r√©e avec succ√®s (133s) mais affichage `[object Object]`

**Cause :** Le mod√®le retourne les **donn√©es binaires de l'image** (Uint8Array stream) au lieu d'une URL.

```
[Nano Banana Pro] Stream item: Uint8Array(1186) [112, 63, 35, 29, ...]
[Nano Banana Pro] Stream item: Uint8Array(1186) [116, 82, 86, 54, ...]
[Nano Banana Pro] Stream item: Uint8Array(622) [35, 189, 71, 146, ...]
```

**Solution :** Collecter les chunks binaires et les convertir en base64 :

```typescript
// Collecter tous les chunks du stream
const chunks: Uint8Array[] = [];
for await (const chunk of output as AsyncIterable<Uint8Array>) {
  if (chunk instanceof Uint8Array) {
    chunks.push(chunk);
  }
}

// Combiner en un seul buffer
const totalLength = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
const combined = new Uint8Array(totalLength);
let offset = 0;
for (const chunk of chunks) {
  combined.set(chunk, offset);
  offset += chunk.length;
}

// Convertir en data URI base64
const base64 = Buffer.from(combined).toString('base64');
const imageUrl = `data:image/jpeg;base64,${base64}`;
```

---

#### ‚ùå Probl√®me 4 : Images de R√©f√©rence (URLs vs Base64)

**Erreur :** `Prediction failed: null` uniquement avec `image_input`

**Cause :** Le mod√®le n'acceptait pas les URLs HTTP Cloudinary directement.

**Hypoth√®se confirm√©e :** Sans r√©f√©rences = ‚úÖ fonctionne | Avec r√©f√©rences = ‚ùå √©choue

**Solution :** Convertir les URLs Cloudinary en **data URIs base64** avant envoi :

```typescript
async function urlToBase64(url: string): Promise<string> {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();
  const base64 = Buffer.from(arrayBuffer).toString('base64');
  const contentType = response.headers.get('content-type') || 'image/png';
  return `data:${contentType};base64,${base64}`;
}

// Dans generateImage()
const base64Images = await Promise.all(
  allReferenceUrls.map(url => urlToBase64(url))
);
input.image_input = base64Images;
```

---

### Architecture Finale

**Fichier** : `app/src/lib/nanobanana.ts`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    generateImage()                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. R√©cup√©rer les 6 URLs Cloudinary (base-portraits.ts)      ‚îÇ
‚îÇ 2. Convertir chaque URL en base64 data URI                  ‚îÇ
‚îÇ 3. Construire le prompt (character.ts + template)           ‚îÇ
‚îÇ 4. Appeler google/nano-banana-pro via Replicate             ‚îÇ
‚îÇ    - prompt: string                                         ‚îÇ
‚îÇ    - image_input: string[] (base64 data URIs)               ‚îÇ
‚îÇ    - aspect_ratio: "4:5"                                    ‚îÇ
‚îÇ    - resolution: "2K"                                       ‚îÇ
‚îÇ    - output_format: "jpg"                                   ‚îÇ
‚îÇ 5. Collecter les chunks Uint8Array du stream                ‚îÇ
‚îÇ 6. Combiner en buffer unique                                ‚îÇ
‚îÇ 7. Convertir en base64 data URI pour affichage              ‚îÇ
‚îÇ 8. Retourner { success: true, imageUrl: data:image/... }    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Fichier** : `app/src/config/base-portraits.ts`

- URLs Cloudinary des 6 photos par d√©faut
- Variables `.env.local` pour override

**Fichier** : `app/src/app/api/test-nanobanana/route.ts`

- Endpoint POST pour tests
- Utilise `generateImage()` de nanobanana.ts

**Fichier** : `app/src/app/test-nanobanana/page.tsx`

- Interface de test avec toggle r√©f√©rences ON/OFF
- Affichage r√©sultat + historique
- Lightbox pour comparaison

---

### Performances Mesur√©es

| M√©trique | Valeur |
|----------|--------|
| **Temps g√©n√©ration** | 60-150 secondes |
| **Taille image** | ~500KB-1MB (JPEG 2K) |
| **Co√ªt estim√©** | ~$0.05-0.10 par image |
| **Taux de succ√®s** | ‚úÖ 100% (apr√®s corrections) |

---

### R√©sultat Final

**‚úÖ Nano Banana Pro fonctionne** avec les 6 photos de r√©f√©rence Cloudinary !

L'image g√©n√©r√©e :
- Maintient les traits du visage des r√©f√©rences
- Respecte le prompt (v√™tements, pose, d√©cor)
- Qualit√© 2K Instagram-ready
- Format JPEG optimis√©

---

---

## ‚úÖ PHASE 4 : Lieux Actifs (TERMIN√â)

### 4 Lieux avec prompts ultra-d√©taill√©s

| # | Lieu | Style | Cr√©neaux |
|---|------|-------|----------|
| 1 | **Chambre Mila** | Boh√®me punk rock fun | morning, evening, night |
| 2 | **Salon Mila** | Vue toits Paris, m√™me aesthetic | evening, night |
| 3 | **KB Caf√©Shop** | Specialty coffee Paris 18e | morning, midday |
| 4 | **L'Usine Paris** | Gym industriel premium | morning, midday |

**Approche** : Prompts bas√©s sur photos r√©elles (KB Caf√©Shop, L'Usine) pour plus d'authenticit√© et possibilit√© de tagger les lieux.

**Documentation** : `docs/11-LIEUX-ACTIFS.md`

---

## ‚úÖ PHASE 5 : Calendrier Intelligent (TERMIN√â)

### Syst√®me cr√©√©

| Composant | Description |
|-----------|-------------|
| **Cr√©neaux** | 6h30, 11h30, 18h00 |
| **Lumi√®re soleil** | Calcul sunrise/sunset par mois √† Paris |
| **Adaptation saison** | Hiver 6h30 = nuit ‚Üí contenu cozy indoor |
| **Jour/Weekend** | Contenu diff√©rent samedi/dimanche |
| **Content templates** | Poses, expressions, tenues par contexte |

### Fichiers cr√©√©s

- `app/src/config/calendar.ts` ‚Äî Logique calendrier
- `app/src/config/locations.ts` ‚Äî ACTIVE_LOCATIONS avec prompts
- `app/src/app/api/calendar/route.ts` ‚Äî API test

### Test du calendrier (3 d√©c 2024, hiver)

```
üìÖ Date: 2024-12-03 (weekday, winter)
‚òÄÔ∏è Sunrise: 8h30 | Sunset: 16h45
---
‚è∞ 06:30 MORNING ‚Üí Lieu: gym | Lighting: NIGHT (il fait nuit!)
‚è∞ 11:30 MIDDAY  ‚Üí Lieu: gym | Lighting: daylight
‚è∞ 18:00 EVENING ‚Üí Lieu: salon | Lighting: NIGHT
```

---

## üîÑ PROCHAINES √âTAPES

### ~~Phase 6 : Images de r√©f√©rence lieux~~ ‚úÖ FAIT

### ~~Phase 7 : Construction prompt automatique~~ ‚úÖ FAIT

### ~~Phase 8 : Perplexity + Caption~~ ‚úÖ FAIT

### Phase 9 : Production

1. [ ] Flow complet de g√©n√©ration automatique
2. [ ] D√©ploiement Vercel + cron jobs

---

## üìä M√©triques Session (3 d√©c)

| M√©trique | Valeur |
|----------|--------|
| **Documents modifi√©s** | 2 (03-PERSONNAGE.md, nanobanana.ts) |
| **Lignes ajout√©es** | ~500 lignes total |
| **Photos g√©n√©r√©es** | 6/6 ‚úÖ |
| **Prompts cr√©√©s** | 6 prompts ultra-d√©taill√©s |
| **It√©rations poitrine** | 3 (C/D ‚Üí DD/E ‚Üí E/F) |
| **Probl√®mes r√©solus** | 4 (nom mod√®le, params, output, URLs) |
| **Dur√©e session** | ~4-5h |

---

---

# üìÖ Session du 4 D√©cembre 2024 (soir) ‚Äî Prompt Builder V2 & Perplexity

**Date** : 4 d√©cembre 2024  
**Dur√©e** : ~2h  
**Objectif** : Finaliser le syst√®me de g√©n√©ration intelligent + int√©grer Perplexity

---

## ‚úÖ PHASE 6 : URLs R√©f√©rences Lieux (TERMIN√â)

### 4 images de lieux upload√©es sur Cloudinary

| # | Lieu | URL Cloudinary |
|---|------|----------------|
| 1 | Chambre Mila | `1._Chambre_Paris_u2lyut.png` |
| 2 | Salon Mila | `2._Salon_Paris_ltyd8r.png` |
| 3 | L'Usine Paris (Gym) | `3._Gym_eewa9s.png` |
| 4 | KB Caf√©Shop | `4._KB_Caf√©Shop_Paris_18_a06ebs.png` |

**Fichier modifi√©** : `app/src/config/locations.ts`
- Ajout du champ `referenceImageUrl` pour chaque lieu actif

---

## ‚úÖ PHASE 7 : Prompt Builder Intelligent (TERMIN√â)

### 7.1 Character Prompt V2 Ultra-D√©taill√©

**Fichier** : `app/src/config/character.ts`

Enrichissements :
- Face details avec distinctive marks (3 grains de beaut√© + freckles)
- Body proportions d√©taill√©es
- Section [VIBE] : "Effortlessly sexy, alluring without being explicit"
- Negative prompts par type de contenu

### 7.2 Syst√®me de G√©n√©ration Contextuel

**Fichier** : `app/src/lib/nanobanana.ts`

Nouvelles fonctions :
- `buildContextualPrompt()` ‚Äî Combine character + location + brief
- `generateFromCalendar()` ‚Äî G√©n√©ration automatis√©e depuis calendrier
- Support de 7 r√©f√©rences images (6 Mila + 1 lieu)

### 7.3 Coh√©rence Tenue/Lieu

**Fichier** : `app/src/config/calendar.ts`

Nouveau syst√®me `LOCATION_OUTFITS` :
```typescript
const LOCATION_OUTFITS = {
  nice_gym: [
    'matching sports bra and high-waisted leggings, form-fitting',
    'fitted sports bra and bike shorts, athletic but feminine',
    // ... 7 options par lieu
  ],
  home_bedroom: [...],
  home_living_room: [...],
  nice_old_town_cafe: [...],
};
```

**R√®gle** : Pas de couleurs sp√©cifiques ‚Üí l'IA varie les couleurs √† chaque g√©n√©ration

### 7.4 Props Intelligents (Lieu + Heure)

**Fichier** : `app/src/config/calendar.ts`

Nouveau syst√®me `LOCATION_PROPS` :
```typescript
const LOCATION_PROPS = {
  home_bedroom: {
    morning: ['messy sheets', 'coffee cup on nightstand', ...],
    evening: ['soft lamp light', 'book', 'candle lit', ...],
    night: ['glass of wine on nightstand', 'candle', ...],
  },
  // ... par lieu et par heure
};
```

**Plus de caf√© dans le lit le soir !** üç∑

### 7.5 Actions Dynamiques (pas juste poses)

**Fichier** : `app/src/config/calendar.ts`

Nouveau syst√®me `LOCATION_ACTIONS` :
```typescript
const LOCATION_ACTIONS = {
  nice_gym: [
    'mid-squat on smith machine, weights loaded, focused determination',
    'doing cable rows, pulling weight toward body, muscles engaged',
    'doing lunges across gym floor, dynamic movement, hair flowing',
    // 12 actions par lieu
  ],
  // ...
};
```

**Le prompt insiste maintenant** : "DYNAMIC ACTION shot - she is doing something, not just posing"

### 7.6 Fix Lighting Jour/Nuit

**Fichier** : `app/src/lib/nanobanana.ts`

Instructions de lighting explicites :
```typescript
if (brief.lighting === 'night') {
  lightingInstructions = `[LIGHTING - CRITICAL] 
- Interior: Artificial lighting only (lamps, spotlights)
- Exterior visible through windows: DARK NIGHT, no daylight
- No natural daylight coming through windows`;
}
```

---

## ‚úÖ PHASE 8 : Perplexity Integration (TERMIN√â)

### 8.1 Lib Perplexity

**Fichier** : `app/src/lib/perplexity.ts`

Fonctions cr√©√©es :
- `fetchDailyTrends()` ‚Äî Recherche trends France du jour
- `generateCaption()` ‚Äî G√©n√®re caption contextuelle avec trends
- `combineHashtags()` ‚Äî Mix trending + evergreen hashtags
- `checkPerplexityStatus()` ‚Äî V√©rifie API status
- Fallback captions si API indisponible

### 8.2 API Route Daily Trends

**Fichier** : `app/src/app/api/daily-trends/route.ts`

Endpoints :
- `GET /api/daily-trends` ‚Äî R√©cup√®re trends du jour (cach√©s 24h)
- `POST /api/daily-trends` ‚Äî G√©n√®re caption pour contenu sp√©cifique

**Exemple de r√©ponse POST** :
```json
{
  "success": true,
  "caption": "Post-workout glow > makeup üí™",
  "hashtags": ["#fitgirl", "#motivation", "#gymlife", "#fitfrenchgirl", "#milaverne"],
  "mood": "energetic",
  "formattedPost": "Post-workout glow > makeup üí™\n\n#fitgirl #motivation #gymlife..."
}
```

### 8.3 Configuration Requise

**Variable d'environnement** : `PERPLEXITY_API_KEY`

Obtenir sur : https://www.perplexity.ai/settings/api

---

## üÜï Page de Test Contextuel

**Fichier** : `app/src/app/test-contextual/page.tsx`

Interface de test pour :
- Mode Auto (calendrier choisit tout)
- Mode Slot (morning/midday/evening)
- Mode Lieu (choisir un lieu sp√©cifique)

**URL** : http://localhost:3000/test-contextual

---

## üìä M√©triques Session (4 d√©c soir)

| M√©trique | Valeur |
|----------|--------|
| **Fichiers cr√©√©s** | 3 (perplexity.ts, daily-trends/route.ts, test-contextual/page.tsx) |
| **Fichiers modifi√©s** | 4 (character.ts, nanobanana.ts, calendar.ts, locations.ts) |
| **Lignes ajout√©es** | ~800 lignes total |
| **Syst√®mes cr√©√©s** | 5 (tenues, props, actions, lighting, perplexity) |
| **Tests g√©n√©ration** | 5+ images valid√©es |

---

## üîú PROCHAINE SESSION : Phase 9 Production

1. [ ] Flow complet auto-post (g√©n√©ration ‚Üí caption ‚Üí Buffer ‚Üí Instagram)
2. [ ] D√©ploiement Vercel
3. [ ] Configuration cron jobs (6h30, 11h30, 18h00)
4. [ ] Tests production pendant 48h

---

## üìö R√©f√©rences Techniques

- **Mod√®le** : https://replicate.com/google/nano-banana-pro
- **Perplexity API** : https://docs.perplexity.ai/
- **Package** : `replicate` npm

---

*Session termin√©e ‚Äî 4 d√©cembre 2024, 22h45*

