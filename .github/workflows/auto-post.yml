name: Mila Auto Post (LEGACY)

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ‚ö†Ô∏è DEPRECATED: Ce workflow est remplac√© par Content Brain
# Les CRON sont d√©sactiv√©s. Gard√© pour d√©clenchement manuel uniquement.
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

on:
  # CRON D√âSACTIV√âS - Utilisez content-brain.yml
  # schedule: [...]
  
  workflow_dispatch:
    inputs:
      slot:
        description: 'Time slot (morning, late_morning, afternoon, evening, night)'
        required: false
        default: ''
      test_mode:
        description: 'Test mode (no publish)'
        required: false
        default: 'false'
        type: boolean

jobs:
  auto-post:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./app
        run: npm install replicate

      - name: Determine slot from schedule
        id: slot
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          DAY=$(date -u +%u)  # 1=Monday, 7=Sunday
          
          # Manual trigger with specific slot
          if [ -n "${{ github.event.inputs.slot }}" ]; then
            echo "slot=${{ github.event.inputs.slot }}" >> $GITHUB_OUTPUT
            echo "Using manual slot: ${{ github.event.inputs.slot }}"
            exit 0
          fi
          
          # Determine slot based on current UTC time and day
          echo "Day of week (1=Mon, 7=Sun): $DAY"
          echo "Current UTC time: $HOUR:$MINUTE"
          
          # LUNDI (day 1) - 2 posts
          if [ "$DAY" -eq 1 ]; then
            if [ "$HOUR" -eq 11 ]; then
              echo "slot=late_morning" >> $GITHUB_OUTPUT
              echo "Monday late_morning slot (12h30 Paris)"
            else
              echo "slot=evening" >> $GITHUB_OUTPUT
              echo "Monday evening slot (21h Paris)"
            fi
          
          # MARDI-JEUDI (days 2-4) - 3 posts standard
          elif [ "$DAY" -ge 2 ] && [ "$DAY" -le 4 ]; then
            if [ "$HOUR" -eq 7 ] || [ "$HOUR" -eq 6 ]; then
              echo "slot=morning" >> $GITHUB_OUTPUT
              echo "Midweek morning slot (8h30 Paris)"
            elif [ "$HOUR" -eq 16 ] || [ "$HOUR" -eq 15 ]; then
              echo "slot=afternoon" >> $GITHUB_OUTPUT
              echo "Midweek afternoon slot (17h Paris)"
            else
              echo "slot=evening" >> $GITHUB_OUTPUT
              echo "Midweek evening slot (21h15 Paris)"
            fi
          
          # VENDREDI (day 5) - 3 posts prep weekend
          elif [ "$DAY" -eq 5 ]; then
            if [ "$HOUR" -eq 11 ]; then
              echo "slot=late_morning" >> $GITHUB_OUTPUT
              echo "Friday late_morning slot (12h30 Paris)"
            elif [ "$HOUR" -eq 18 ] || [ "$HOUR" -eq 17 ]; then
              echo "slot=afternoon" >> $GITHUB_OUTPUT
              echo "Friday afternoon slot (19h Paris)"
            else
              echo "slot=evening" >> $GITHUB_OUTPUT
              echo "Friday evening slot (21h15 Paris)"
            fi
          
          # WEEKEND (days 6, 0/7) - 4 posts BEST DAYS üî•
          else
            if [ "$HOUR" -eq 10 ] || [ "$HOUR" -eq 9 ]; then
              echo "slot=late_morning" >> $GITHUB_OUTPUT
              echo "Weekend late_morning slot (11h Paris) üî•"
            elif [ "$HOUR" -eq 16 ] || [ "$HOUR" -eq 15 ]; then
              echo "slot=afternoon" >> $GITHUB_OUTPUT
              echo "Weekend afternoon slot (17h Paris) üî•"
            elif [ "$HOUR" -eq 20 ] || [ "$HOUR" -eq 19 ]; then
              echo "slot=evening" >> $GITHUB_OUTPUT
              echo "Weekend evening slot (21h Paris) üî•"
            else
              echo "slot=night" >> $GITHUB_OUTPUT
              echo "Weekend night slot (23h Paris) üî•"
            fi
          fi

      - name: Generate and Post Carousel
        working-directory: ./app
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          INSTAGRAM_ACCOUNT_ID: ${{ secrets.INSTAGRAM_ACCOUNT_ID }}
        run: |
          SLOT="${{ steps.slot.outputs.slot }}"
          TEST="${{ github.event.inputs.test_mode }}"
          DAY=$(date -u +%u)
          DAY_NAME=$(date -u +%A)
          
          echo "üöÄ Starting carousel generation"
          echo "üìÖ Day: $DAY_NAME (day $DAY)"
          echo "‚è∞ Slot: $SLOT"
          echo "üß™ Test mode: $TEST"
          
          # Log the schedule info
          if [ "$DAY" -eq 1 ]; then
            echo "üìâ Monday = Low effort day (-38% engagement)"
          elif [ "$DAY" -eq 6 ] || [ "$DAY" -eq 0 ]; then
            echo "üî• Weekend = Best engagement day (+55-60%)"
          fi
          
          node scripts/carousel-post.mjs "$SLOT" "$TEST"
