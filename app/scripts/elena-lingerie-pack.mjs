#!/usr/bin/env node
/**
 * Elena Lingerie Pack - 5 photos
 * Dual IP-Adapter: FaceID (face) + IPAdapter (style/location)
 * Poses generated by Grok
 */

const COMFYUI_URL = 'http://127.0.0.1:8188';

const POSES = [
  {
    name: '01_elegant_standing',
    prompt: `elena, standing tall and poised, weight shifted to one leg, other slightly bent,
one hand resting lightly on hip accentuating waist curve, other hand trailing along collarbone,
shoulders relaxed back, chest gently lifted,
wearing black lace balconette bra with delicate straps, matching high-waisted sheer French lace panties,
thin gold chain necklace falling between collarbones, small diamond stud earrings,
soft confident expression, half-lidded eyes gazing at camera, lips slightly parted in subtle knowing smile,
visible cleavage, nipples visible through sheer lace,
Haussmannian Paris apartment, tall windows, natural light illuminating silhouette,
8k, photorealistic, detailed skin texture`
  },
  {
    name: '02_stockings_chaise',
    prompt: `elena, sitting on edge of ornate velvet chaise, legs crossed at thigh showing garter clips,
one foot arched emphasizing stocking seam running up back of calf,
hands resting lightly on upper thigh, fingers tracing lace edge of stocking tops,
torso slightly turned toward camera, back straight,
wearing sheer black mesh bodysuit with built-in garter straps, sheer black stockings with classic back seam,
black satin garter belt visible through mesh, delicate black lace gloves reaching mid-forearm,
sultry composed expression, eyes looking down toward legs, lower lip caught between teeth,
visible curves through mesh, nipples visible,
Haussmannian apartment, parquet floor, ornate moldings,
8k, photorealistic, detailed skin texture`
  },
  {
    name: '03_playful_mirror',
    prompt: `elena, kneeling on plush rug in front of gilded mirror, torso twisted toward camera,
one knee down other raised, one hand playfully tugging at bra strap as if about to slip,
other hand covering mouth in mock surprise, hips tilted, back slightly arched creating S-curve,
wearing soft blush-pink satin babydoll chemise with ruffled hem barely reaching mid-thigh,
matching lace panties, thin silk robe loosely draped off one shoulder threatening to fall,
mischievous flirtatious expression, wide eyes raised eyebrows, coy grin behind fingers,
bare legs, visible cleavage, hint of nipple,
Haussmannian apartment, gilded mirror reflection showing back,
8k, photorealistic, detailed skin texture`
  },
  {
    name: '04_intimate_bed',
    prompt: `elena, reclining against piled pillows on grand bed, upper body propped on elbows,
knees bent and slightly parted, one hand trailing across ribcage toward underside of breast,
other hand resting palm-down on inner thigh thumb stroking softly, back gently arched, head tilted back exposing throat,
wearing delicate ivory lace bralette no underwire, matching high-cut thong,
sheer ivory kimono robe open slipping off both shoulders,
expression lost in sensation, eyes closed, lips parted in soft exhale, quiet pleasure,
visible breasts through sheer lace, nipples erect, thighs parted suggestively,
Haussmannian bedroom, luxurious bedding, soft diffused light,
8k, photorealistic, detailed skin texture`
  },
  {
    name: '05_sensual_daybed',
    prompt: `elena, lying on side across velvet daybed near tall French windows, body in languid S-shape,
bottom leg extended straight, top leg bent drawn up accentuating hip curve,
lower arm stretched overhead hand dangling elegantly, upper hand resting on stomach below bra line,
head turned toward camera, hair fanned across cushion,
wearing deep emerald silk and lace teddy with plunging neckline and high-cut legs,
sheer black thigh-high stockings without garters, long pearl strand draped across waist,
dreamy inviting expression, half-lidded eyes gazing at lens, soft smile relaxed and open,
visible cleavage, side of breast, curves highlighted,
Haussmannian apartment, French windows, diffused Parisian afternoon light, ornate moldings,
8k, photorealistic, detailed skin texture`
  }
];

function createDualIPAdapterWorkflow(prompt, seed, outputPrefix) {
  return {
    // Checkpoint
    "1": {
      "class_type": "CheckpointLoaderSimple",
      "inputs": { "ckpt_name": "bigLove_xl1.safetensors" }
    },
    // LoRA Elena
    "2": {
      "class_type": "LoraLoader",
      "inputs": {
        "model": ["1", 0],
        "clip": ["1", 1],
        "lora_name": "elena_v4_cloud.safetensors",
        "strength_model": 1.0,
        "strength_clip": 1.0
      }
    },
    // Positive prompt
    "3": {
      "class_type": "CLIPTextEncode",
      "inputs": { "clip": ["2", 1], "text": prompt }
    },
    // Negative prompt
    "4": {
      "class_type": "CLIPTextEncode",
      "inputs": {
        "clip": ["2", 1],
        "text": "ugly, deformed, bad anatomy, bad hands, missing fingers, extra fingers, blurry, low quality, watermark, text, cartoon, 3d render, anime"
      }
    },
    // Empty latent
    "5": {
      "class_type": "EmptyLatentImage",
      "inputs": { "width": 832, "height": 1216, "batch_size": 1 }
    },
    // Face reference image
    "6": {
      "class_type": "LoadImage",
      "inputs": { "image": "elena_face_ref.jpg" }
    },
    // Style/Location reference image (Haussmannian salon)
    "7": {
      "class_type": "LoadImage",
      "inputs": { "image": "replicate-prediction-aphj5sddfxrmc0cv5sf8eqe2pw.png" }
    },
    // CLIP Vision
    "8": {
      "class_type": "CLIPVisionLoader",
      "inputs": { "clip_name": "CLIP-ViT-H-14-laion2B-s32B-b79K.safetensors" }
    },
    // IP-Adapter FaceID model
    "9": {
      "class_type": "IPAdapterModelLoader",
      "inputs": { "ipadapter_file": "faceid.plusv2.sdxl.bin" }
    },
    // IP-Adapter Plus model (for style)
    "10": {
      "class_type": "IPAdapterModelLoader",
      "inputs": { "ipadapter_file": "ip-adapter-plus_sdxl_vit-h.safetensors" }
    },
    // InsightFace for FaceID
    "11": {
      "class_type": "IPAdapterInsightFaceLoader",
      "inputs": { "provider": "CPU", "model_name": "buffalo_l" }
    },
    // Apply FaceID IP-Adapter FIRST
    "12": {
      "class_type": "IPAdapterFaceID",
      "inputs": {
        "model": ["2", 0],
        "ipadapter": ["9", 0],
        "image": ["6", 0],
        "clip_vision": ["8", 0],
        "insightface": ["11", 0],
        "weight": 0.85,
        "weight_faceidv2": 0.85,
        "weight_type": "linear",
        "combine_embeds": "concat",
        "start_at": 0.0,
        "end_at": 1.0,
        "embeds_scaling": "V only"
      }
    },
    // Apply Style IP-Adapter SECOND (on top of FaceID result)
    "13": {
      "class_type": "IPAdapterAdvanced",
      "inputs": {
        "model": ["12", 0],
        "ipadapter": ["10", 0],
        "image": ["7", 0],
        "clip_vision": ["8", 0],
        "weight": 0.35,
        "weight_type": "ease in-out",
        "combine_embeds": "concat",
        "start_at": 0.0,
        "end_at": 0.5,
        "embeds_scaling": "V only"
      }
    },
    // Sampler
    "14": {
      "class_type": "KSampler",
      "inputs": {
        "model": ["13", 0],
        "positive": ["3", 0],
        "negative": ["4", 0],
        "latent_image": ["5", 0],
        "seed": seed,
        "steps": 30,
        "cfg": 3.5,
        "sampler_name": "dpmpp_2m_sde",
        "scheduler": "karras",
        "denoise": 1.0
      }
    },
    // VAE Decode
    "15": {
      "class_type": "VAEDecode",
      "inputs": { "samples": ["14", 0], "vae": ["1", 2] }
    },
    // Save
    "16": {
      "class_type": "SaveImage",
      "inputs": { "images": ["15", 0], "filename_prefix": outputPrefix }
    }
  };
}

async function queuePrompt(workflow) {
  const response = await fetch(`${COMFYUI_URL}/prompt`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt: workflow })
  });
  return await response.json();
}

async function waitForCompletion(promptId, maxWait = 600000) {
  const start = Date.now();
  while (Date.now() - start < maxWait) {
    const response = await fetch(`${COMFYUI_URL}/history/${promptId}`);
    const history = await response.json();
    if (history[promptId]?.outputs) {
      return history[promptId];
    }
    await new Promise(r => setTimeout(r, 3000));
    process.stdout.write('.');
  }
  throw new Error('Timeout');
}

async function main() {
  console.log('üì∏ ELENA LINGERIE PACK - 5 PHOTOS');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log('');
  console.log('Dual IP-Adapter:');
  console.log('  ‚Ä¢ FaceID Plus v2 (0.85) ‚Üí Visage Elena');
  console.log('  ‚Ä¢ IP-Adapter Plus (0.35) ‚Üí Style Haussmannien');
  console.log('');
  console.log('Poses by Grok AI');
  console.log('');
  
  const baseSeed = Math.floor(Math.random() * 1000000);
  
  // Check which pose to generate (arg or all)
  const poseArg = process.argv[2];
  const posesToGenerate = poseArg 
    ? POSES.filter((_, i) => (i + 1).toString() === poseArg)
    : POSES;
  
  if (poseArg && posesToGenerate.length === 0) {
    console.log(`Usage: node elena-lingerie-pack.mjs [1-5]`);
    console.log('  Sans argument: g√©n√®re les 5 photos');
    console.log('  Avec num√©ro: g√©n√®re seulement cette pose');
    process.exit(0);
  }
  
  for (let i = 0; i < posesToGenerate.length; i++) {
    const pose = posesToGenerate[i];
    const poseNum = POSES.indexOf(pose) + 1;
    
    console.log(`\n[${i + 1}/${posesToGenerate.length}] Pose ${poseNum}: ${pose.name}`);
    
    const workflow = createDualIPAdapterWorkflow(pose.prompt, baseSeed + poseNum, `elena_lingerie_${pose.name}`);
    
    try {
      const result = await queuePrompt(workflow);
      if (result.error) {
        console.log(`    ‚ùå Erreur: ${JSON.stringify(result.error)}`);
        continue;
      }
      
      console.log(`    ‚è≥ G√©n√©ration en cours...`);
      process.stdout.write('    ');
      await waitForCompletion(result.prompt_id);
      console.log(`\n    ‚úÖ ~/ComfyUI/output/elena_lingerie_${pose.name}_*.png`);
    } catch (err) {
      console.log(`    ‚ùå ${err.message}`);
    }
  }
  
  console.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log('‚úÖ Pack termin√© !');
}

main().catch(console.error);
